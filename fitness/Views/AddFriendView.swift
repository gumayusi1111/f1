import SwiftUI
import FirebaseFirestore

struct AddFriendView: View {
    @State private var searchText = ""
    @State private var searchResults: [User] = []
    @State private var isSearching = false
    @State private var showError = false
    @State private var errorMessage = ""
    @AppStorage("userId") private var userId: String = ""
    @AppStorage("userName") private var userName: String = ""
    
    var body: some View {
        ScrollView {
            VStack(spacing: 20) {
                // ÊêúÁ¥¢Ê°ÜÈÉ®ÂàÜ
                searchBarSection
                
                // ÊêúÁ¥¢ÁªìÊûúÈÉ®ÂàÜ
                searchResultsSection
            }
            .padding()
        }
        .navigationTitle("Ê∑ªÂä†Â•ΩÂèã")
        .alert("ÊèêÁ§∫", isPresented: $showError) {
            Button("Á°ÆÂÆö", role: .cancel) { }
        } message: {
            Text(errorMessage)
        }
    }
    
    // ÊêúÁ¥¢Ê°ÜÈÉ®ÂàÜ
    private var searchBarSection: some View {
        VStack(spacing: 12) {
            HStack {
                Image(systemName: "magnifyingglass")
                    .foregroundColor(.gray)
                
                TextField("ËæìÂÖ•Áî®Êà∑ÂêçÊêúÁ¥¢", text: $searchText)
                    .textFieldStyle(PlainTextFieldStyle())
                    .autocapitalization(.none)
                
                if !searchText.isEmpty {
                    Button(action: { searchText = "" }) {
                        Image(systemName: "xmark.circle.fill")
                            .foregroundColor(.gray)
                    }
                }
            }
            .padding()
            .background(
                RoundedRectangle(cornerRadius: 12)
                    .fill(Color(.systemGray6))
            )
            
            Button(action: performSearch) {
                HStack {
                    Image(systemName: "person.badge.plus")
                    Text("ÊêúÁ¥¢Â•ΩÂèã")
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(
                    RoundedRectangle(cornerRadius: 12)
                        .fill(searchText.isEmpty ? Color.gray : Color.blue)
                )
                .foregroundColor(.white)
            }
            .disabled(searchText.isEmpty)
        }
    }
    
    // ÊêúÁ¥¢ÁªìÊûúÈÉ®ÂàÜ
    private var searchResultsSection: some View {
        VStack(spacing: 15) {
            if isSearching {
                ProgressView()
                    .frame(maxWidth: .infinity, minHeight: 200)
            } else if searchResults.isEmpty && !searchText.isEmpty {
                emptyResultView
            } else {
                ForEach(searchResults) { user in
                    UserResultCard(user: user, onAdd: {
                        sendFriendRequest(to: user)
                    })
                }
            }
        }
    }
    
    // Á©∫ÁªìÊûúËßÜÂõæ
    private var emptyResultView: some View {
        VStack(spacing: 12) {
            Image(systemName: "person.slash")
                .font(.system(size: 50))
                .foregroundColor(.gray)
            
            Text("Êú™ÊâæÂà∞Áî®Êà∑")
                .font(.headline)
                .foregroundColor(.gray)
            
            Text("Êç¢‰∏™Áî®Êà∑ÂêçËØïËØïÂêß")
                .font(.subheadline)
                .foregroundColor(.gray)
        }
        .frame(maxWidth: .infinity, minHeight: 200)
    }
    
    private func performSearch() {
        guard !searchText.isEmpty else { return }
        
        isSearching = true
        searchResults = []
        
        let db = Firestore.firestore()
        db.collection("users")
            .whereField("name", isGreaterThanOrEqualTo: searchText)
            .whereField("name", isLessThanOrEqualTo: searchText + "\u{f8ff}")
            .getDocuments(source: .default) { snapshot, error in
                isSearching = false
                
                if let error = error {
                    print("Search error: \(error.localizedDescription)")
                    errorMessage = error.localizedDescription
                    showError = true
                    return
                }
                
                // Ê∑ªÂä†Ë∞ÉËØïÊâìÂç∞
                print("Search query: \(searchText)")
                
                searchResults = snapshot?.documents.compactMap { doc -> User? in
                    do {
                        var user = try doc.data(as: User.self)
                        user.id = doc.documentID
                        print("Successfully decoded user: \(user.username) with ID: \(user.id)")
                        return user
                    } catch {
                        print("Error decoding user document \(doc.documentID): \(error)")
                        
                        // Â∞ùËØïÊâãÂä®ÂàõÂª∫Áî®Êà∑ÂØπË±°
                        let data = doc.data()
                        if let name = data["name"] as? String {
                            return User(
                                id: doc.documentID,
                                username: name,
                                avatar_base64: data["avatar_base64"] as? String,
                                onlineStatus: User.OnlineStatus.offline,
                                lastStatusUpdate: (data["lastStatusUpdate"] as? Timestamp)?.dateValue(),
                                friendIds: data["friendIds"] as? [String] ?? []
                            )
                        }
                        return nil
                    }
                }.filter { $0.id != userId } ?? []
                
                print("Final search results count: \(searchResults.count)")
            }
    }
    
    private func sendFriendRequest(to user: User) {
        print("\n========== ÂºÄÂßãÂèëÈÄÅÂ•ΩÂèãËØ∑Ê±Ç ==========")
        print("‰ªéÁî®Êà∑: \(userName) (ID: \(userId))")
        print("ÂèëÈÄÅÁªô: \(user.username) (ID: \(user.id))")
        
        let db = Firestore.firestore()
        
        // 1. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòØÂ•ΩÂèã
        if user.friendIds.contains(userId) {
            errorMessage = "Â∑≤ÁªèÊòØÂ•ΩÂèã‰∫Ü"
            showError = true
            print("‚ùå Â∑≤ÁªèÊòØÂ•ΩÂèã‰∫Ü")
            return
        }
        
        // 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂèëÈÄÅËøáËØ∑Ê±Ç
        print("üìù Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂèëÈÄÅËøáËØ∑Ê±Ç...")
        db.collection("friendRequests")
            .whereField("fromUserId", isEqualTo: userId)
            .whereField("toUserId", isEqualTo: user.id)
            .whereField("status", isEqualTo: FriendRequest.RequestStatus.pending.rawValue)
            .getDocuments(source: .default) { snapshot, error in
                if let error = error {
                    errorMessage = error.localizedDescription
                    showError = true
                    print("‚ùå Ê£ÄÊü•ËØ∑Ê±ÇÂ§±Ë¥•: \(error.localizedDescription)")
                    return
                }
                
                if !(snapshot?.documents.isEmpty ?? true) {
                    errorMessage = "Â∑≤ÁªèÂèëÈÄÅËøáËØ∑Ê±Ç‰∫Ü"
                    showError = true
                    print("‚ùå Â∑≤ÁªèÂèëÈÄÅËøáËØ∑Ê±Ç‰∫Ü")
                    return
                }
                
                print("‚úÖ Êú™ÂèëÁé∞ÈáçÂ§çËØ∑Ê±ÇÔºåÁªßÁª≠Â§ÑÁêÜ...")
                
                // 3. ÂàõÂª∫Êñ∞ÁöÑÂ•ΩÂèãËØ∑Ê±Ç
                let requestId = UUID().uuidString
                let request = FriendRequest(
                    id: requestId,
                    fromUserId: userId,
                    fromUsername: userName,
                    toUserId: user.id,
                    status: .pending,
                    timestamp: Date()
                )
                
                print("üì§ Ê≠£Âú®‰øùÂ≠òËØ∑Ê±Ç... ID: \(requestId)")
                
                // 4. ‰øùÂ≠òËØ∑Ê±Ç
                let requestData: [String: Any] = [
                    "id": request.id,
                    "fromUserId": request.fromUserId,
                    "fromUsername": request.fromUsername,
                    "toUserId": request.toUserId,
                    "status": request.status.rawValue,
                    "timestamp": Timestamp(date: request.timestamp)
                ]
                
                db.collection("friendRequests")
                    .document(requestId)
                    .setData(requestData) { error in
                        if let error = error {
                            errorMessage = "ÂèëÈÄÅËØ∑Ê±ÇÂ§±Ë¥•Ôºö\(error.localizedDescription)"
                            showError = true
                            print("‚ùå ‰øùÂ≠òËØ∑Ê±ÇÂ§±Ë¥•: \(error.localizedDescription)")
                        } else {
                            print("‚úÖ Â•ΩÂèãËØ∑Ê±ÇÂèëÈÄÅÊàêÂäüÔºÅ")
                            // ÂèØ‰ª•Ê∑ªÂä†ÊàêÂäüÊèêÁ§∫
                            errorMessage = "ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ"
                            showError = true
                        }
                    }
            }
        
        print("========== ÂèëÈÄÅËØ∑Ê±ÇÊµÅÁ®ãÂêØÂä® ==========\n")
    }
}

// Áî®Êà∑ÁªìÊûúÂç°ÁâáÁªÑ‰ª∂
struct UserResultCard: View {
    let user: User
    let onAdd: () -> Void
    
    var body: some View {
        HStack(spacing: 15) {
            // Â§¥ÂÉè
            if let avatarData = Data(base64Encoded: user.avatar_base64 ?? ""),
               let uiImage = UIImage(data: avatarData) {
                Image(uiImage: uiImage)
                    .resizable()
                    .scaledToFill()
                    .frame(width: 50, height: 50)
                    .clipShape(Circle())
            } else {
                Image(systemName: "person.circle.fill")
                    .resizable()
                    .frame(width: 50, height: 50)
                    .foregroundColor(.gray)
            }
            
            // Áî®Êà∑‰ø°ÊÅØ
            VStack(alignment: .leading, spacing: 4) {
                Text(user.username)
                    .font(.headline)
                
                Text("ID: \(user.id)")
                    .font(.caption)
                    .foregroundColor(.gray)
                
                // Âú®Á∫øÁä∂ÊÄÅ - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
                HStack(spacing: 6) {
                    Image(systemName: statusIcon(user.onlineStatus))
                        .foregroundColor(statusColor(user.onlineStatus))
                        .font(.system(size: 12))
                    
                    Text("\(statusText(user.onlineStatus)) (\(user.onlineStatus.rawValue))")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
                .onAppear {
                    print("User online status: \(user.onlineStatus)")
                }
            }
            
            Spacer()
            
            // Ê∑ªÂä†ÊåâÈíÆ
            Button(action: onAdd) {
                Image(systemName: "person.badge.plus")
                    .font(.system(size: 20))
                    .foregroundColor(.white)
                    .frame(width: 36, height: 36)
                    .background(Circle().fill(Color.blue))
            }
        }
        .padding()
        .background(
            RoundedRectangle(cornerRadius: 12)
                .fill(Color(.systemBackground))
                .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
        )
    }
    
    // Áä∂ÊÄÅËæÖÂä©ÂáΩÊï∞
    private func statusIcon(_ status: User.OnlineStatus) -> String {
        switch status {
        case .online: return "circle.fill"
        case .away: return "moon.fill"
        case .offline: return "circle.slash"
        }
    }
    
    private func statusColor(_ status: User.OnlineStatus) -> Color {
        switch status {
        case .online: return .green
        case .away: return .yellow
        case .offline: return .gray
        }
    }
    
    private func statusText(_ status: User.OnlineStatus) -> String {
        switch status {
        case .online: return "Âú®Á∫ø"
        case .away: return "Á¶ªÂºÄ"
        case .offline: return "Á¶ªÁ∫ø"
        }
    }
} 